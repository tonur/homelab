#!/usr/sbin/nft -f
flush ruleset

# edge_gateway_mode: {{ edge_gateway_mode }} (template rendered)

table inet filter {
  chain input {
    type filter hook input priority 0;
    policy drop;
    ct state {established, related} accept
    iif lo accept
    # Allow SSH via tailscale (100.64.0.0/10) or WireGuard peer
    ip saddr 100.64.0.0/10 tcp dport 22 accept
    ip saddr {{ edge_gateway_wg_peer }} tcp dport 22 accept
    # Allow SSH from anywhere (broad). Consider tightening later with CIDR list.
    tcp dport 22 accept
    # Allow WireGuard UDP
    udp dport {{ edge_gateway_wireguard_port }} accept
    # Allow DNS on standard port 53 (HAProxy will proxy to {{ edge_gateway_coredns_nodeport }})
    udp dport 53 accept
    tcp dport 53 accept
    # Allow DNS on NodePort from WireGuard peer (for direct access if needed)
    ip saddr {{ edge_gateway_wg_peer }} udp dport {{ edge_gateway_coredns_nodeport }} accept
    ip saddr {{ edge_gateway_wg_peer }} tcp dport {{ edge_gateway_coredns_nodeport }} accept
    # HTTP/HTTPS ingress (either to local proxy or for DNAT prerouting)
    tcp dport { {{ edge_gateway_ingress_ports | join(', ') }} } accept
  }
  chain forward {
    type filter hook forward priority 0;
    policy drop;
    ct state {established, related} accept
    # Allow WireGuard interface traffic forwarding (needed for peer communication)
    iif "wg0" accept
    oif "wg0" accept
    {% if edge_gateway_mode == 'dnat' %}
    # DNAT forwarding path eth0 -> wg0 limited to backend VIP ports
    iif "eth0" oif "wg0" tcp dport { {{ edge_gateway_ingress_ports | join(', ') }} } ip daddr {{ edge_gateway_traefik_vip }} accept
    iif "wg0" oif "eth0" ct state {established, related} accept
    {% else %}
    # Proxy mode: HAProxy forwards traffic over wg0 to backend services
    # Allow HAProxy to reach Traefik NodePorts
    iif "lo" oif "wg0" tcp dport { {{ edge_gateway_proxy_backend_http_port }}, {{ edge_gateway_proxy_backend_https_port }} } ip daddr {{ edge_gateway_traefik_vip }} accept
    # Allow HAProxy to reach CoreDNS NodePort  
    iif "lo" oif "wg0" udp dport {{ edge_gateway_coredns_nodeport }} ip daddr {{ edge_gateway_traefik_vip }} accept
    iif "lo" oif "wg0" tcp dport {{ edge_gateway_coredns_nodeport }} ip daddr {{ edge_gateway_traefik_vip }} accept
    iif "wg0" oif "lo" ct state {established, related} accept
    {% endif %}
  }
  chain output {
    type filter hook output priority 0;
    policy accept;
  }
}

{% if edge_gateway_mode == 'dnat' %}
# DNAT mode NAT table
table ip nat {
  chain prerouting {
    type nat hook prerouting priority -100;
    # DNAT inbound HTTP/HTTPS to Traefik VIP
    tcp dport 80  dnat to {{ edge_gateway_traefik_vip }}:80
    tcp dport 443 dnat to {{ edge_gateway_traefik_vip }}:443
    # DNS is handled by HAProxy, not DNAT
  }
  chain postrouting {
    type nat hook postrouting priority 100;
    # No MASQUERADE to preserve client IP (requires symmetric routing)
  }
}
{% else %}
# Proxy mode: no DNAT or SNAT; HAProxy terminates TCP and re-initiates to backend over wg0.
{% endif %}
