---
# gitops-bootstrap role: Bootstrap GitOps infrastructure
# 
# This role sets up the minimal components needed to bootstrap GitOps:
# - Retrieves kubeconfig from k3s server
# - Creates Bitwarden credentials secret in 'default' namespace (for ESO)
# - Applies GitRepository and Kustomization for Flux to manage the cluster
# 
# After this role completes, Flux manages all infrastructure and applications from Git.

- name: Fetch kubeconfig from k3s server
  fetch:
    src: /etc/rancher/k3s/k3s.yaml
    dest: /tmp/k3s-kubeconfig.yaml
    flat: yes

- name: Get Tailscale IP for k3s server
  shell: tailscale status --json | jq -r '.Peer[] | select(.HostName == "gigabyte") | .TailscaleIPs[0]'
  register: k3s_server_tailscale_ip
  delegate_to: localhost
  run_once: true

- name: Fix kubeconfig server URL to use Tailscale IP
  replace:
    path: /tmp/k3s-kubeconfig.yaml
    regexp: 'https://127\.0\.0\.1:6443'
    replace: 'https://{{ k3s_server_tailscale_ip.stdout }}:6443'
  delegate_to: localhost

- name: Set localhost kubeconfig environment
  set_fact:
    kubeconfig_env:
      KUBECONFIG: /tmp/k3s-kubeconfig.yaml

- name: Install kubectl if not present on localhost
  shell: |
    if ! command -v kubectl &> /dev/null; then
      curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
      sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
      rm kubectl
    fi
  delegate_to: localhost
  run_once: true

- name: Install Flux CLI if not present
  shell: |
    if ! command -v flux &> /dev/null; then
      curl -s https://fluxcd.io/install.sh | sudo bash
    fi
  delegate_to: localhost
  run_once: true

- name: Check if Flux is already installed in the cluster
  shell: |
    kubectl get namespace flux-system 2>/dev/null || echo "not-found"
  register: flux_namespace_check
  delegate_to: localhost
  run_once: true
  environment: "{{ kubeconfig_env }}"
  changed_when: false

- name: Debug namespace check result
  debug:
    var: flux_namespace_check

- name: Install Flux controllers if not present
  shell: |
    kubectl apply -f https://github.com/fluxcd/flux2/releases/latest/download/install.yaml
  delegate_to: localhost
  run_once: true
  environment: "{{ kubeconfig_env }}"
  register: flux_install_result
  when: '"not-found" in flux_namespace_check.stdout'

- name: Debug Flux installation result
  debug:
    var: flux_install_result
  when: flux_install_result is defined

- name: Wait for Flux deployments to be ready
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    namespace: flux-system
    wait: true
    wait_condition:
      type: Available
      status: "True"
    wait_timeout: 300
  delegate_to: localhost
  run_once: true
  environment: "{{ kubeconfig_env }}"
  when: flux_install_result is defined and flux_install_result.changed

- name: Wait for GitRepository CRD to be available
  kubernetes.core.k8s_info:
    api_version: apiextensions.k8s.io/v1
    kind: CustomResourceDefinition
    name: gitrepositories.source.toolkit.fluxcd.io
    wait: true
    wait_condition:
      type: Established
      status: "True"
    wait_timeout: 60
  delegate_to: localhost
  run_once: true
  environment: "{{ kubeconfig_env }}"
  when: flux_install_result is defined and flux_install_result.changed

- name: Create Bitwarden credentials secret in default namespace for ESO bootstrap
  kubernetes.core.k8s:
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: bitwarden-credentials
        namespace: default
      type: Opaque
      stringData:
        BW_ACCESS_TOKEN: "{{ bw_access_token }}"
    state: present
  delegate_to: localhost
  run_once: true
  environment: "{{ kubeconfig_env }}"
  no_log: true

- name: Bootstrap GitOps - Apply Git repository and cluster kustomization
  kubernetes.core.k8s:
    state: present
    definition: "{{ item }}"
  delegate_to: localhost
  run_once: true
  environment: "{{ kubeconfig_env }}"
  loop: "{{ lookup('file', playbook_dir + '/../bootstrap.yaml') | from_yaml_all | list }}"

# Note: All namespaces, ESO deployment, and other secrets will be managed by Flux/GitOps.
# ESO will use a ClusterSecretStore to access this bootstrap secret from the default namespace.
