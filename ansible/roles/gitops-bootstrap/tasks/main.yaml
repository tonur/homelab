---
# gitops-bootstrap role: Bootstrap GitOps infrastructure
# 
# This role sets up the minimal components needed to bootstrap GitOps:
# - Retrieves kubeconfig from k3s server
# - Creates Bitwarden credentials secret in 'default' namespace (for ESO)
# - Applies GitRepository and Kustomization for Flux to manage the cluster
# 
# After this role completes, Flux manages all infrastructure and applications from Git.

- name: Fetch kubeconfig from k3s server
  fetch:
    src: /etc/rancher/k3s/k3s.yaml
    dest: /tmp/k3s-kubeconfig.yaml
    flat: yes

- name: Fix kubeconfig server URL
  replace:
    path: /tmp/k3s-kubeconfig.yaml
    regexp: 'https://127\.0\.0\.1:6443'
    replace: 'https://{{ ansible_host }}:6443'
  delegate_to: localhost

- name: Set localhost kubeconfig environment
  set_fact:
    kubeconfig_env:
      KUBECONFIG: /tmp/k3s-kubeconfig.yaml

- name: Install Flux CLI if not present
  shell: |
    if ! command -v flux &> /dev/null; then
      curl -s https://fluxcd.io/install.sh | sudo bash
    fi
  delegate_to: localhost
  run_once: true

- name: Check if Flux is already installed in the cluster
  kubernetes.core.k8s_info:
    api_version: source.toolkit.fluxcd.io/v1
    kind: GitRepository
    namespace: flux-system
  register: flux_gitrepo_crd
  delegate_to: localhost
  run_once: true
  environment: "{{ kubeconfig_env }}"
  failed_when: false

- name: Reinstall Flux with latest version if CRDs are missing
  shell: |
    flux uninstall --silent || true
    sleep 10
    flux install --components-extra=image-reflector-controller,image-automation-controller --timeout=5m
  delegate_to: localhost
  run_once: true
  environment: "{{ kubeconfig_env }}"
  when: flux_gitrepo_crd.api_found is not defined or not flux_gitrepo_crd.api_found
  register: flux_install_result

- name: Wait for Flux CRDs to be available
  kubernetes.core.k8s_info:
    api_version: source.toolkit.fluxcd.io/v1
    kind: GitRepository
    namespace: flux-system
  register: wait_for_crds
  until: wait_for_crds.api_found is defined and wait_for_crds.api_found
  retries: 30
  delay: 10
  delegate_to: localhost
  run_once: true
  environment: "{{ kubeconfig_env }}"
  when: flux_gitrepo_crd.api_found is not defined or not flux_gitrepo_crd.api_found

- name: Create Bitwarden credentials secret in default namespace for ESO bootstrap
  kubernetes.core.k8s:
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: bitwarden-credentials
        namespace: default
      type: Opaque
      stringData:
        BW_ACCESS_TOKEN: "{{ bw_access_token }}"
    state: present
  delegate_to: localhost
  run_once: true
  environment: "{{ kubeconfig_env }}"
  no_log: true

- name: Bootstrap GitOps - Apply Git repository and cluster kustomization
  kubernetes.core.k8s:
    state: present
    definition: "{{ item }}"
  delegate_to: localhost
  run_once: true
  environment: "{{ kubeconfig_env }}"
  loop: "{{ lookup('file', playbook_dir + '/../bootstrap.yaml') | from_yaml_all | list }}"

# Note: All namespaces, ESO deployment, and other secrets will be managed by Flux/GitOps.
# ESO will use a ClusterSecretStore to access this bootstrap secret from the default namespace.
