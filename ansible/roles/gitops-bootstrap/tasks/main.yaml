---
# gitops-bootstrap role: Bootstrap GitOps infrastructure
# 
# This role sets up the minimal components needed to bootstrap GitOps:
# - Retrieves kubeconfig from k3s server
# - Creates Bitwarden credentials secret in 'default' namespace (for ESO)
# - Applies GitRepository and Kustomization for Flux to manage the cluster
# 
# After this role completes, Flux manages all infrastructure and applications from Git.

- name: Fetch kubeconfig from k3s server
  fetch:
    src: /etc/rancher/k3s/k3s.yaml
    dest: /tmp/k3s-kubeconfig.yaml
    flat: yes

- name: Derive k3s server hostname
  set_fact:
    derived_k3s_server_host: "{{ groups['k3s_server'] | first }}"
  when: derived_k3s_server_host is not defined

- name: Derive k3s server Tailscale IP from hostvars
  set_fact:
    k3s_server_tailscale_ip: "{{ hostvars[derived_k3s_server_host].current_tailscale_ip }}"
  when: k3s_server_tailscale_ip is not defined

- name: Fail if Tailscale IP fact missing (ensure control-plane play captured current_tailscale_ip)
  fail:
    msg: "current_tailscale_ip not found in hostvars for control-plane host {{ derived_k3s_server_host }}. Ensure k3s-control-plane role ran first."
  when: k3s_server_tailscale_ip is not defined or (k3s_server_tailscale_ip | length) == 0

- name: Fix kubeconfig server URL to use Tailscale IP
  replace:
    path: /tmp/k3s-kubeconfig.yaml
    regexp: 'https://127\.0\.0\.1:6443'
    replace: 'https://{{ k3s_server_tailscale_ip }}:6443'
  delegate_to: localhost
  become: false

- name: Set localhost kubeconfig environment
  set_fact:
    kubeconfig_env:
      KUBECONFIG: /tmp/k3s-kubeconfig.yaml

- name: Check if Flux is already installed in the cluster
  shell: |
    kubectl get namespace flux-system 2>/dev/null || echo "not-found"
  register: flux_namespace_check
  delegate_to: localhost
  run_once: true
  environment: "{{ kubeconfig_env }}"
  changed_when: false
  become: false

- name: Debug namespace check result
  debug:
    var: flux_namespace_check

- name: Install Flux controllers if not present
  shell: |
    kubectl apply -f https://github.com/fluxcd/flux2/releases/latest/download/install.yaml
  delegate_to: localhost
  run_once: true
  environment: "{{ kubeconfig_env }}"
  register: flux_install_result
  when: '"not-found" in flux_namespace_check.stdout'
  become: false

- name: Debug Flux installation result
  debug:
    var: flux_install_result
  when: flux_install_result is defined

- name: Wait for Flux deployments to be ready
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    namespace: flux-system
    wait: true
    wait_condition:
      type: Available
      status: "True"
    wait_timeout: 300
  delegate_to: localhost
  run_once: true
  environment: "{{ kubeconfig_env }}"
  when: flux_install_result is defined and flux_install_result.changed
  become: false

- name: Wait for GitRepository CRD to be available
  kubernetes.core.k8s_info:
    api_version: apiextensions.k8s.io/v1
    kind: CustomResourceDefinition
    name: gitrepositories.source.toolkit.fluxcd.io
    wait: true
    wait_condition:
      type: Established
      status: "True"
    wait_timeout: 60
  delegate_to: localhost
  run_once: true
  environment: "{{ kubeconfig_env }}"
  when: flux_install_result is defined and flux_install_result.changed
  become: false

- name: Create Bitwarden credentials secret in default namespace for ESO bootstrap
  kubernetes.core.k8s:
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: bitwarden-credentials
        namespace: default
      type: Opaque
      stringData:
        BW_ACCESS_TOKEN: "{{ bw_access_token }}"
    state: present
  delegate_to: localhost
  run_once: true
  environment: "{{ kubeconfig_env }}"
  no_log: true
  become: false

- name: Bootstrap GitOps - Apply Git repository and cluster kustomization
  kubernetes.core.k8s:
    state: present
    definition: "{{ item }}"
  delegate_to: localhost
  run_once: true
  environment: "{{ kubeconfig_env }}"
  loop: "{{ lookup('file', playbook_dir + '/../bootstrap.yaml') | from_yaml_all | list }}"
  become: false
